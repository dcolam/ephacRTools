---
title: "getting-started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{getting-started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## Getting Started with ephacRTools

ephacRTools is a library designed to work with single-cell high-throughput 
electrophysiology data coming from Syncropatch measurements. It assumes that
the input excel table has been generated by DataControl and takes any number of
Online Analysis parameters inside it. Make sure to also include Quality Control
metrices such as Series, Seal and Capacitance and export all wells. If you performed
a voltage-clamp protocol with steps, make sure that the holding steps are included 
in the excel file.

In short, ephacRTools converts an Excel-table with sweep-wise information into
a SummarizedExperiment-object (more specifically a SingleCellExperiment object which
is built on a SummarizedExperiment object). These types of objects are convinient to
analyse multi-variate datasets and perform various operations such as dimensionality reduction.

The structure of the SummarizedExperiment (se) objects are as follows:

- All numeric columns in the Excel-table (mainly Online Analysis (OA) values and 
  Quality Control metrices (Seal, Series, Capacitance etc.)) are 
  imported as numeric metrices called assays.
- rowData contains information about the single sweeps. This can include information such as
  voltage holding potential or compounds added at different sweeps. If these information varies
  between wells, for instance compounds that have been added to different columns of the 384 well plate,
  they will be displayed as DataFrames giving the general layout of the experiment
- colData contains information about the single wells and can include the QC, Plate_ID (if more than one 
  experiment is analyzed) and conditions.
  
Furthermore, we added the possibility to include imaging datasets (correlative imaging),
including wrapper functions to store the data in colData

We included two sample datasets with ephys and imaging data:
- se_hAG: human adrenal gland project, where primary adrenal gland cells where 
  patched and analyzed for sodium permeability using a voltage-ramp
- 4 different measurements (3 plate_ids) with 3 different imaging datasets

- se_iN: iPSC-derived neuron (iNeurons) dataset project, where iNeurons where patched
  using a step-wise clamp protocol from -80mV to +20mV
- Including an imaging dataset

### Install the package from Source

Still in development

Pull the repo on https://github.com/dcolam/ephacRTools.git

```{r message=FALSE, warning=FALSE}

#devtools::install_github("https://github.com/dcolam/ephacRTools.git")
devtools::load_all()
```



### Load Sample Dataset

```{r setup}
#library(ephacRTools)
data(se_iN)
se_iN
```
### Image Results inside Column Data Explained

Inside Column Data, we also have 3 different dataframes, for each imaging channel (C1, C2, C3).
These dataframes have information about the particles that were found inside the measuring pore.

For example for C2 or the green channel:

```{r}
head(colData(se_iN)$C2[complete.cases(colData(se_iN)$C2),])

```


### Adding column-wise Means of some Assays

This function is useful to aggregate some assays to single values and store them 
in colData. The aggregationg is based on all sweeps for now.

```{r}
se_iN <- colAG(se_iN, assayList = c("Seal", "Series", "Capacitance"))
```
## Perform Dimensionality Reduction based on any number of assays or colData-columns

You can choose any number of assays or columns from colData to perform a PCA, TSNE or UMAP based
dimensionality reduction. By default, the function also adds a K-means clustering into the colData.

The results of the dimensionality reduction is stored inside reducedDim(se).

We included also plotting wrapper functions to visualize the results.

```{r}
se_iN <- reducedDim.Cellwise(se_iN, assayList = c("Minima"))
plotDimRed(se_iN, "UMAP")
```

### Plotting any assay against sweeps

The wrapper function plotAssayVSSweeps helps plotting any assay against sweeps.

You can also include rowData information such as V_Clamp and include groupings.

```{r}

plotAssayVSSweeps(se_iN, "Minima", "V_Clamp", colorGroup = "cluster.umap", wrapFormula = .~cluster.umap)

```

### Create your own SummarizedExperiment object

There are two steps to create a se object with ephys and imaging data together.

Make sure that the Excel-file comes out of DataControl and the .db from 
Cluster-Analysis plugin in Fiji.

Tutorials are going to follow.

For example:

```{r}

l_files <- list.files(path = "../data-raw/iNeurons/" ,pattern = "*.xlsx$", recursive = TRUE, full.names = TRUE)

se_iN <- prepareSE(l_files)

l_files <- list.files(path = "../data-raw/iNeurons/" ,pattern = "*.db$", recursive = TRUE, full.names = TRUE)
df_img <- prepareImgDF(l_files, scale_num = TRUE, analysis = "pa")

se_iN <- mergeSEandImg(se_iN, df_img, tableType = "pa")

```





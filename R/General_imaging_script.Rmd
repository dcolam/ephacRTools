---
title: "Imaging_script_Gen"
author: "Athena Schumacher"
date: "2025-05-21"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Load Useful Packages and Functions

```{r message=FALSE, warning=FALSE}

source("/Users/athenaschumacher/Downloads/E-Phac:Robinson_Labs/ephacRTools/R/imagingTools.R")
source("/Users/athenaschumacher/Downloads/E-Phac:Robinson_Labs/ephacRTools/R/utilityTools.R")
source("/Users/athenaschumacher/Downloads/E-Phac:Robinson_Labs/ephacRTools/R/prepareSE.R")
source("/Users/athenaschumacher/Downloads/E-Phac:Robinson_Labs/ephacRTools/R/colDatTools.R")

```


```{r}

devtools::load_all()

data("se_iN")

colData(se_iN)[15:25,]

```

```{r}

wells <- se_iN$Well
plateIDs <- se_iN$Plate_ID

parent_folder <- "/Volumes/staff/ephacoffice/DColameo/DATA/iPSC_Tricultures"

image_paths_list <- mapply(function(well, plate, location) {
  image_paths(parent_folder, idx = well, plate = plate, location = 7)
}, well = wells, plate = plateIDs, SIMPLIFY = FALSE)

colData(se_iN)$Image_paths <- image_paths_list 

# Check 
colData(se_iN)$Image_paths

se_iN[,se_iN$Well == "H05"]$Image_paths

```

Visualize the different channels for a given well of a given plate
```{r}

imageval(se_iN, "C09", "18T39265")

```



Adrenal cells

```{r}

wd_path <- "/Users/athenaschumacher/Downloads/E-Phac:Robinson_Labs/excel_files"

pathToTable <- "/Users/athenaschumacher/Downloads/E-Phac:Robinson_Labs/excel_files/NCI_ramp_ATP1A1_280225_18T39417.xlsx"

df <- prep_excel(pathToTable)

df <- prep_df(wd_path, df)

df <- filtered_df(df, "18T39417")

df <- group_assignment(df, pattern = "Cycle", cycle_pattern = c("HP", "WT", "HP"))

```

```{r}
se_hAG <- prepareSE(pathToTable)

parent_folder <- "/Volumes/staff/ephacoffice/DColameo/DATA/human_AG_Sinergia"
plate = "18T39417"

wells <- se_hAG$Well
plateIDs <- se_hAG$Plate_ID

image_paths_list <- mapply(function(well, plate, location=6) {
  image_paths(parent_folder, idx = well, plate = plate, location = 6)
}, well = wells, plate = plateIDs, SIMPLIFY = FALSE)

colData(se_hAG)$Image_paths <- image_paths_list 

# Check 
colData(se_hAG)$Image_paths

se_hAG[,se_hAG$Well == "H05"]$Image_paths

```


```{r}
se_coldata <- as.data.frame(colData(se_hAG))

df_clean <- df %>%
  select(Well, Plate_ID, Compound, Group) %>%
  distinct(Well, Plate_ID, .keep_all = TRUE)

matched <- left_join(se_coldata, df_clean, by = c("Well", "Plate_ID"))

se_hAG$Compound <- matched$Compound
se_hAG$Group <- matched$Group

colData(se_hAG)[30:40,]
```


Save additions in colData
```{r}
df_mean_byConc <- rowAG(se_hAG, assay_name = "Erev", FUN=mean, mode="by.period")

rd <- as.data.frame(rowData(se_hAG))
rd$Na_Conc = case_when(
        rd$Sweep <= 24 ~ 0.08,
        rd$Sweep <= 42 ~ 0.04,
        rd$Sweep <= 60 ~ 0.02,
        rd$Sweep <= 84 ~ 0.01,
        TRUE ~ NA_real_
)
rd$Step <- factor(
  cut(rd$Sweep, breaks = c(0, 24, 42, 60, 84, Inf), 
      labels = c("Add1", "Add2", "Add3", "Add4", "Out")),
  levels = c("Add1", "Add2", "Add3", "Add4", "Out")
  )
rowData(se_hAG) <- DataFrame(rd)

df_mean  <- rowAG(se_hAG, assay_name = "Erev", FUN = mean)

cd <- as.data.frame(colData(se_hAG))
cd <- left_join(cd, df_mean, by = c("Well","Plate_ID","QC","Compound","Group"))
colData(se_hAG) <- DataFrame(cd)

se_hAG <- df_mean_byConcse_hse_hAGAG 

```

Save Additions as assays
```{r}

se1 <- row_aggregate_SE(se_hAG,
                        metrics = c("Erev"),
                        FUN     = mean,
                        mode    = "by.period")

# 2) mean of last 5 sweeps
se2_mean <- row_aggregate_SE(se_hAG,
                        metrics = "Erev",
                        FUN     = mean,
                        mode    = "last.n",
                        last.n  = 5)

# 2) median of last 5 sweeps 
se2_med <- row_aggregate_SE(se_hAG,
                        metrics = "Erev",
                        FUN     = median,
                        mode    = "last.n",
                        last.n  = 5)

## Check
se_period <- se1

assayNames(se_period)

mat <- assay(se_period, "Erev")
dim(mat)
rownames(mat)
colnames(mat)[1:10]

mat[, 1:6]
head(mat)

summary(as.numeric(mat))

```

```{r}
SETools::aggSE()
```


